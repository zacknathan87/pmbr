services:
  app:
    
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ..:/workspaces:cached
      - ~/.ssh:/home/vscode/.ssh:ro  # Mount SSH keys as read-only
      - ~/.vscode-server-republic:/home/vscode/.vscode-server  # Persist VSCode extensions and settings
    working_dir: /workspaces
    command: supervisord -c /etc/supervisor/conf.d/supervisord.conf
    ports:
      - "1008:80"
      - "8445:443"
    depends_on:
      - db
    environment:
      - DB_HOST=db
      - DB_PORT=3306
      - DB_DATABASE=republic
      - DB_USERNAME=root
      - DB_PASSWORD=
      - PUPPETEER_SKIP_DOWNLOAD=true
      - PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
      - PUPPETEER_ARGS=--no-sandbox,--disable-setuid-sandbox,--disable-dev-shm-usage,--disable-gpu

  db:
    image: mariadb:10.6
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ""
      MYSQL_DATABASE: republic
      MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
    ports:
      - "3307:3306"
    volumes:
      - db_data:/var/lib/mysql

volumes:
  db_data:
